# 12-factor

文章地址：https://12factor.net/zh_cn/

## 简介
如今，软件通常会作为一种服务来交付，它们被称为网络应用程序，或软件即服务（SaaS）。12-Factor 为构建如下的`SaaS`应用提供了方法论：
* 使用标准化流程自动配置，从而使新的开发者花费最少的学习成本加入这个项目。
* 和操作系统之间尽可能的划清界限，在各个系统中提供最大的可移植性。
* 适合部署在现代的云计算平台，从而在服务器和系统管理方面节省资源。
* 将开发环境和生产环境的差异降至最低，并使用持续交付实施敏捷开发。
* 可以在工具、架构和开发流程不发生明显变化的前提下实现扩展。
这套理论适用于任意语言和后端服务（数据库、消息队列、缓存等）开发的应用程序。

## I. 基准代码
> 一份基准代码，多份部署

基准代码和应用之间总是保持一一对应的关系：
* 一旦有多个基准代码，就不能称为一个应用，而是一个分布式系统。分布式系统中的每一个组件都是一个应用，每一个应用可以分别使用`12-Factor`进行开发。
* 多个应用共享一份基准代码是有悖于`12-Factor`原则的。解决方案是将共享的代码拆分为独立的类库，然后使用`依赖管理`策略去加载它们。

## II. 依赖
> 显式声明依赖关系

12-Factor规则下的应用程序不会隐式依赖系统级的类库。 它一定通过`依赖清单`，确切地声明所有依赖项。此外，在运行过程中通过`依赖隔离`工具来确保程序不会调用系统中存在但清单中未声明的依赖项。这一做法会统一应用到生产和开发环境。			

例如：python中使用pip作为`依赖声明`，使用virtualenv作为`依赖隔离`

## III. 配置
> 在环境中存储配置

12-Factor推荐将应用的配置存储于`环境变量`中。环境变量可以非常方便地在不同的部署间做修改，却不动一行代码；与配置文件不同，不小心把它们签入代码库的概率微乎其微；与一些传统的解决配置问题的机制（比如 Java 的属性配置文件）相比，环境变量与语言和系统无关。			

*判断一个应用是否正确地将配置排除在代码之外，一个简单的方法是看该应用的基准代码是否可以立刻开源，而不用担心会暴露任何敏感的信息。*

## IV. 后端服务
> 把后端服务(backing services)当作附加资源

后端服务是指程序运行所需要的通过网络调用的各种服务，如数据库（MySQL，CouchDB），消息/队列系统（RabbitMQ，Beanstalkd），SMTP邮件发送服务（Postfix），以及缓存系统（Memcached）。		

每个不同的后端服务是一份`资源`。例如，一个`MySQL`数据库是一个资源，两个`MySQL`数据库（用来数据分区）就被当作是2个不同的资源。12-Factor应用将这些数据库都视作`附加资源`，这些资源和它们附属的部署保持松耦合。		

## V. 构建，发布，运行
> 严格分离构建和运行

`基准代码`转化为一份部署(非开发环境)需要以下三个阶段：
* `构建阶段`是指将代码仓库转化为可执行包的过程。构建时会使用指定版本的代码，获取和打包 依赖项，编译成二进制文件和资源文件。
* `发布阶段`会将构建的结果和当前部署所需`配置`相结合，并能够立刻在运行环境中投入使用。
* `运行阶段`（或者说“运行时”）是指针对选定的发布版本，在执行环境中启动一系列应用程序`进程`。

## VI. 进程
> 以一个或多个无状态进程运行应用

运行环境中，应用程序通常是以一个和多个`进程`运行的。12-Factor应用的进程必须无状态且无共享。 任何需要持久化的数据都要存储在`后端服务`内，比如数据库。

## VII. 端口绑定
> 通过端口绑定(Port binding)提供服务

12-Factor应用完全`自我加载`而不依赖于任何网络服务器就可以创建一个面向网络的服务。互联网应用 通过端口绑定来提供服务，并监听发送至该端口的请求。

## VIII. 并发
> 通过进程模型进行扩展

## IX. 易处理
> 快速启动和优雅终止可最大化健壮性

12-Factor 应用的进程是易处理（disposable）的，意思是说它们可以瞬间开启或停止。 这有利于快速、弹性的伸缩应用，迅速部署变化的代码或配置，稳健的部署应用。
* 进程应当追求**最小启动时间**
* 进程一旦接收**终止信号（SIGTERM）**就会优雅的终止 
* 进程还应当在面对突然死亡时保持健壮，例如底层硬件故障

## X. 开发环境与线上环境等价
> 尽可能的保持开发，预发布，线上环境相同

从以往经验来看，开发环境（即开发人员的本地部署）和线上环境（外部用户访问的真实部署）之间存在着很多差异。这些差异表现在以下三个方面：
* 时间差异： 开发人员正在编写的代码可能需要几天，几周，甚至几个月才会上线。
* 人员差异： 开发人员编写代码，运维人员部署代码。
* 工具差异： 开发人员或许使用 Nginx，SQLite，OS X，而线上环境使用 Apache，MySQL 以及 Linux。

12-Factor应用想要做到`持续部署`就必须缩小本地与线上差异。 再回头看上面所描述的三个差异:
* 缩小时间差异：开发人员可以几小时，甚至几分钟就部署代码。
* 缩小人员差异：开发人员不只要编写代码，更应该密切参与部署过程以及代码在线上的表现。
* 缩小工具差异：尽量保证开发环境以及线上环境的一致性。

## XI. 日志
> 把日志当作事件流

12-factor应用本身从不考虑存储自己的输出流。 不应该试图去写或者管理日志文件。相反，每一个运行的进程都会直接的标准输出（stdout）事件流。开发环境中，开发人员可以通过这些数据流，实时在终端看到应用的活动。在预发布或线上部署中，每个进程的输出流由运行环境截获，并将其他输出流整理在一起，然后一并发送给一个或多个最终的处理程序，用于查看或是长期存档。这些存档路径对于应用来说不可见也不可配置，而是完全交给程序的运行环境管理。			


## XII. 管理进程
> 后台管理任务当作一次性进程运行
