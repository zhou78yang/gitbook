# 数据库隔离级别

## 事务
事务就是一组原子性的SQL查询，或者说一个独立的工作单元。如果数据库引擎能够成功地对数据库应用该组查询的全部语句，那么就执行该组查询。
如果其中有任何一条语句因为崩溃或其他原因无法执行，那么所有的语句都不会执行。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。

事务是恢复和并发控制的基本单位。

### 事务的ACID
事务具有四个特征：
* 原子性（Atomicity）: 事务是数据库的逻辑工作单位，事务中包含的操作，要么都做，要么都不做
* 一致性（Consistency）: 事务执行的结果必须使数据库从一个一致性状态变到另一个一致性状态。保证数据库一致性是指当事务完成时，必须使所有数据都具有一致的状态。
* 隔离性（Isolation）: 一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对其他并发事务是隔离的，并发执行的各个事务之间不能互相干扰
* 持久性（Durability）: 一个事务一单提交，它对数据库中的数据的改变就应该是永久性的。


## MySQL四种隔离级别
SQL标准中定义了四种隔离级别，每一种级别都规定了一个事务中所作的修改，哪些在事务内和事务间是可见的，哪些是不可见的。
较低级别的隔离通常可以支持更高的并发，系统开销也更低。

### 读未提交（Read Uncommitted）
在READ UNCOMMITTED级别，事务中的修改即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据，这也被称为**脏读(dirty read)**。
这个级别会导致很多问题，从性能上来说，READ UNCOMMITTED不会比其他的级别好太多，但却缺乏其他级别的很多好处，除非真的有非常必要的理由，在实际应用中一般很少使用。

### 读已提交（Read Committed）
大多数数据库系统的默认隔离级别都是READ COMMITTED (但MySQL不是)。
READ COMMITTED满足前面提到的隔离性的简单定义：一个事务开始时，只能“看见”已经提交的事务所做的修改。
换句话说，一个事务从开始直到提交之前，所做的任何修改对其他事务都是不可见的。
这个级别有时候也叫做**不可重复读(non-repeatable read)**。因为两次执行同样的查询，可能会得到不一样的结果。
(在事务处理期间并发的其他事务可能会有新的commit)

### 可重复读（Repeatable Read）
REPEATABLE READ解决了脏读的问题。该级别保证了在同一个事务中多次读取同样记录的结果是一致的。（快照读）
但是理论上，可重复读隔离级别还是无法解决另外一个**幻读(phantom read)**的问题。

所谓幻读，指的是当某个事务在读取某个范围内的记录时，另外一个事务又在该范围内插入了新的记录。
当之前的事务再次读取该范围的记录时，会产生幻行(phantom row)。

可重复读是MySQL的默认事务隔离级别。

> [!Note]
> InnoDB存储引擎通过多版本并发控制(MVCC， Multi version Concurrency Control)解决了幻读的问题.

#### 当前读和快照读(snapshot)
* 快照读（snapshot）：读取比该事务早的最后一次提交值，用于确保在同一事务中重复读取相同select查询，结果是一致的。
* 当前读：读到所有已经提交记录的最新值。

### 可串行化（Serializable）
SERIALIZABLE是最高的隔离级别。它通过强制事务串行执行，避免了前面说的**幻读**的问题。
简单来说，SERIALIZABLE会在读取的每一行数据上都加锁，所以可能导致大量的超时和锁争用的问题。
实际应用中也很少用到这个隔离级别，只有在非常需要确保数据的一致性而且可以接受没有并发的情况下，才考虑采用该级别。

### 四种隔离级别比较
![隔离级别](../img/隔离级别.png)


## 测试
测试数据库demo，测试表test，表结构：
```sql
CREATE TABLE `test` (
    `id` INT UNSIGNED NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(50) NOT NULL DEFAULT '',
    `age` INT NOT NULL DEFAULT 0,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```
两个客户端C1和C2，C1模拟正在执行的事务，C2模拟并发的其他事务。

* [读未提交/脏读](./脏读test.md)
* [读已提交/不可重复读](./不可重复读test.md)
* [可重复读/幻读](./幻读test.md)
